/*
 * Copyright Allo authors. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

#include <aie_api/aie.hpp>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <type_traits>
#define NOCPP

constexpr float SIGMOID_MAX_X = 5.0f;
constexpr float SIGMOID_MIN_X = -5.0f;
constexpr int SIGMOID_LUT_SIZE = 600;
constexpr float SIGMOID_STEP = (SIGMOID_MAX_X-SIGMOID_MIN_X) / (SIGMOID_LUT_SIZE - 1);

const float sigmoid_lut[] = {
    6.69285092e-03f, 6.80475584e-03f, 6.91851878e-03f, 7.03417016e-03f,
    7.15174087e-03f, 7.27126229e-03f, 7.39276630e-03f, 7.51628530e-03f,
    7.64185217e-03f, 7.76950034e-03f, 7.89926375e-03f, 8.03117688e-03f,
    8.16527475e-03f, 8.30159294e-03f, 8.44016757e-03f, 8.58103535e-03f,
    8.72423356e-03f, 8.86980003e-03f, 9.01777324e-03f, 9.16819222e-03f,
    9.32109663e-03f, 9.47652674e-03f, 9.63452346e-03f, 9.79512832e-03f,
    9.95838350e-03f, 1.01243318e-02f, 1.02930168e-02f, 1.04644826e-02f,
    1.06387740e-02f, 1.08159366e-02f, 1.09960166e-02f, 1.11790610e-02f,
    1.13651174e-02f, 1.15542343e-02f, 1.17464606e-02f, 1.19418464e-02f,
    1.21404422e-02f, 1.23422994e-02f, 1.25474703e-02f, 1.27560078e-02f,
    1.29679656e-02f, 1.31833983e-02f, 1.34023613e-02f, 1.36249109e-02f,
    1.38511041e-02f, 1.40809988e-02f, 1.43146539e-02f, 1.45521289e-02f,
    1.47934844e-02f, 1.50387818e-02f, 1.52880835e-02f, 1.55414527e-02f,
    1.57989537e-02f, 1.60606514e-02f, 1.63266121e-02f, 1.65969028e-02f,
    1.68715914e-02f, 1.71507470e-02f, 1.74344396e-02f, 1.77227401e-02f,
    1.80157207e-02f, 1.83134543e-02f, 1.86160151e-02f, 1.89234782e-02f,
    1.92359198e-02f, 1.95534173e-02f, 1.98760490e-02f, 2.02038944e-02f,
    2.05370342e-02f, 2.08755501e-02f, 2.12195248e-02f, 2.15690426e-02f,
    2.19241885e-02f, 2.22850488e-02f, 2.26517112e-02f, 2.30242643e-02f,
    2.34027980e-02f, 2.37874036e-02f, 2.41781734e-02f, 2.45752009e-02f,
    2.49785812e-02f, 2.53884102e-02f, 2.58047854e-02f, 2.62278055e-02f,
    2.66575705e-02f, 2.70941816e-02f, 2.75377414e-02f, 2.79883538e-02f,
    2.84461241e-02f, 2.89111589e-02f, 2.93835661e-02f, 2.98634551e-02f,
    3.03509364e-02f, 3.08461223e-02f, 3.13491260e-02f, 3.18600626e-02f,
    3.23790481e-02f, 3.29062004e-02f, 3.34416384e-02f, 3.39854827e-02f,
    3.45378552e-02f, 3.50988794e-02f, 3.56686800e-02f, 3.62473833e-02f,
    3.68351171e-02f, 3.74320106e-02f, 3.80381945e-02f, 3.86538009e-02f,
    3.92789633e-02f, 3.99138170e-02f, 4.05584984e-02f, 4.12131456e-02f,
    4.18778981e-02f, 4.25528970e-02f, 4.32382847e-02f, 4.39342052e-02f,
    4.46408039e-02f, 4.53582278e-02f, 4.60866252e-02f, 4.68261460e-02f,
    4.75769416e-02f, 4.83391647e-02f, 4.91129695e-02f, 4.98985118e-02f,
    5.06959487e-02f, 5.15054387e-02f, 5.23271418e-02f, 5.31612193e-02f,
    5.40078341e-02f, 5.48671503e-02f, 5.57393335e-02f, 5.66245504e-02f,
    5.75229694e-02f, 5.84347600e-02f, 5.93600930e-02f, 6.02991405e-02f,
    6.12520760e-02f, 6.22190740e-02f, 6.32003105e-02f, 6.41959623e-02f,
    6.52062078e-02f, 6.62312262e-02f, 6.72711981e-02f, 6.83263048e-02f,
    6.93967289e-02f, 7.04826540e-02f, 7.15842647e-02f, 7.27017463e-02f,
    7.38352853e-02f, 7.49850688e-02f, 7.61512849e-02f, 7.73341224e-02f,
    7.85337708e-02f, 7.97504202e-02f, 8.09842615e-02f, 8.22354861e-02f,
    8.35042859e-02f, 8.47908532e-02f, 8.60953807e-02f, 8.74180617e-02f,
    8.87590895e-02f, 9.01186576e-02f, 9.14969599e-02f, 9.28941902e-02f,
    9.43105424e-02f, 9.57462102e-02f, 9.72013873e-02f, 9.86762672e-02f,
    1.00171043e-01f, 1.01685908e-01f, 1.03221053e-01f, 1.04776671e-01f,
    1.06352954e-01f, 1.07950090e-01f, 1.09568271e-01f, 1.11207685e-01f,
    1.12868518e-01f, 1.14550959e-01f, 1.16255192e-01f, 1.17981402e-01f,
    1.19729770e-01f, 1.21500478e-01f, 1.23293706e-01f, 1.25109632e-01f,
    1.26948430e-01f, 1.28810274e-01f, 1.30695337e-01f, 1.32603788e-01f,
    1.34535794e-01f, 1.36491519e-01f, 1.38471126e-01f, 1.40474773e-01f,
    1.42502617e-01f, 1.44554811e-01f, 1.46631505e-01f, 1.48732846e-01f,
    1.50858978e-01f, 1.53010039e-01f, 1.55186166e-01f, 1.57387492e-01f,
    1.59614144e-01f, 1.61866246e-01f, 1.64143918e-01f, 1.66447275e-01f,
    1.68776428e-01f, 1.71131481e-01f, 1.73512537e-01f, 1.75919691e-01f,
    1.78353032e-01f, 1.80812647e-01f, 1.83298615e-01f, 1.85811009e-01f,
    1.88349898e-01f, 1.90915343e-01f, 1.93507400e-01f, 1.96126119e-01f,
    1.98771543e-01f, 2.01443707e-01f, 2.04142641e-01f, 2.06868368e-01f,
    2.09620904e-01f, 2.12400256e-01f, 2.15206425e-01f, 2.18039405e-01f,
    2.20899181e-01f, 2.23785731e-01f, 2.26699025e-01f, 2.29639025e-01f,
    2.32605684e-01f, 2.35598948e-01f, 2.38618753e-01f, 2.41665027e-01f,
    2.44737691e-01f, 2.47836654e-01f, 2.50961819e-01f, 2.54113077e-01f,
    2.57290313e-01f, 2.60493401e-01f, 2.63722206e-01f, 2.66976584e-01f,
    2.70256380e-01f, 2.73561431e-01f, 2.76891565e-01f, 2.80246598e-01f,
    2.83626339e-01f, 2.87030584e-01f, 2.90459122e-01f, 2.93911731e-01f,
    2.97388179e-01f, 3.00888225e-01f, 3.04411616e-01f, 3.07958092e-01f,
    3.11527381e-01f, 3.15119201e-01f, 3.18733262e-01f, 3.22369262e-01f,
    3.26026890e-01f, 3.29705826e-01f, 3.33405740e-01f, 3.37126291e-01f,
    3.40867129e-01f, 3.44627897e-01f, 3.48408224e-01f, 3.52207734e-01f,
    3.56026038e-01f, 3.59862742e-01f, 3.63717439e-01f, 3.67589716e-01f,
    3.71479151e-01f, 3.75385310e-01f, 3.79307756e-01f, 3.83246041e-01f,
    3.87199707e-01f, 3.91168292e-01f, 3.95151324e-01f, 3.99148323e-01f,
    4.03158804e-01f, 4.07182274e-01f, 4.11218232e-01f, 4.15266171e-01f,
    4.19325578e-01f, 4.23395934e-01f, 4.27476715e-01f, 4.31567388e-01f,
    4.35667419e-01f, 4.39776266e-01f, 4.43893383e-01f, 4.48018221e-01f,
    4.52150223e-01f, 4.56288832e-01f, 4.60433485e-01f, 4.64583617e-01f,
    4.68738660e-01f, 4.72898042e-01f, 4.77061189e-01f, 4.81227526e-01f,
    4.85396475e-01f, 4.89567458e-01f, 4.93739893e-01f, 4.97913201e-01f,
    5.02086799e-01f, 5.06260107e-01f, 5.10432542e-01f, 5.14603525e-01f,
    5.18772474e-01f, 5.22938811e-01f, 5.27101958e-01f, 5.31261340e-01f,
    5.35416383e-01f, 5.39566515e-01f, 5.43711168e-01f, 5.47849777e-01f,
    5.51981779e-01f, 5.56106617e-01f, 5.60223734e-01f, 5.64332581e-01f,
    5.68432612e-01f, 5.72523285e-01f, 5.76604066e-01f, 5.80674422e-01f,
    5.84733829e-01f, 5.88781768e-01f, 5.92817726e-01f, 5.96841196e-01f,
    6.00851677e-01f, 6.04848676e-01f, 6.08831708e-01f, 6.12800293e-01f,
    6.16753959e-01f, 6.20692244e-01f, 6.24614690e-01f, 6.28520849e-01f,
    6.32410284e-01f, 6.36282561e-01f, 6.40137258e-01f, 6.43973962e-01f,
    6.47792266e-01f, 6.51591776e-01f, 6.55372103e-01f, 6.59132871e-01f,
    6.62873709e-01f, 6.66594260e-01f, 6.70294174e-01f, 6.73973110e-01f,
    6.77630738e-01f, 6.81266738e-01f, 6.84880799e-01f, 6.88472619e-01f,
    6.92041908e-01f, 6.95588384e-01f, 6.99111775e-01f, 7.02611821e-01f,
    7.06088269e-01f, 7.09540878e-01f, 7.12969416e-01f, 7.16373661e-01f,
    7.19753402e-01f, 7.23108435e-01f, 7.26438569e-01f, 7.29743620e-01f,
    7.33023416e-01f, 7.36277794e-01f, 7.39506599e-01f, 7.42709687e-01f,
    7.45886923e-01f, 7.49038181e-01f, 7.52163346e-01f, 7.55262309e-01f,
    7.58334973e-01f, 7.61381247e-01f, 7.64401052e-01f, 7.67394316e-01f,
    7.70360975e-01f, 7.73300975e-01f, 7.76214269e-01f, 7.79100819e-01f,
    7.81960595e-01f, 7.84793575e-01f, 7.87599744e-01f, 7.90379096e-01f,
    7.93131632e-01f, 7.95857359e-01f, 7.98556293e-01f, 8.01228457e-01f,
    8.03873881e-01f, 8.06492600e-01f, 8.09084657e-01f, 8.11650102e-01f,
    8.14188991e-01f, 8.16701385e-01f, 8.19187353e-01f, 8.21646968e-01f,
    8.24080309e-01f, 8.26487463e-01f, 8.28868519e-01f, 8.31223572e-01f,
    8.33552725e-01f, 8.35856082e-01f, 8.38133754e-01f, 8.40385856e-01f,
    8.42612508e-01f, 8.44813834e-01f, 8.46989961e-01f, 8.49141022e-01f,
    8.51267154e-01f, 8.53368495e-01f, 8.55445189e-01f, 8.57497383e-01f,
    8.59525227e-01f, 8.61528874e-01f, 8.63508481e-01f, 8.65464206e-01f,
    8.67396212e-01f, 8.69304663e-01f, 8.71189726e-01f, 8.73051570e-01f,
    8.74890368e-01f, 8.76706294e-01f, 8.78499522e-01f, 8.80270230e-01f,
    8.82018598e-01f, 8.83744808e-01f, 8.85449041e-01f, 8.87131482e-01f,
    8.88792315e-01f, 8.90431729e-01f, 8.92049910e-01f, 8.93647046e-01f,
    8.95223329e-01f, 8.96778947e-01f, 8.98314092e-01f, 8.99828957e-01f,
    9.01323733e-01f, 9.02798613e-01f, 9.04253790e-01f, 9.05689458e-01f,
    9.07105810e-01f, 9.08503040e-01f, 9.09881342e-01f, 9.11240911e-01f,
    9.12581938e-01f, 9.13904619e-01f, 9.15209147e-01f, 9.16495714e-01f,
    9.17764514e-01f, 9.19015738e-01f, 9.20249580e-01f, 9.21466229e-01f,
    9.22665878e-01f, 9.23848715e-01f, 9.25014931e-01f, 9.26164715e-01f,
    9.27298254e-01f, 9.28415735e-01f, 9.29517346e-01f, 9.30603271e-01f,
    9.31673695e-01f, 9.32728802e-01f, 9.33768774e-01f, 9.34793792e-01f,
    9.35804038e-01f, 9.36799690e-01f, 9.37780926e-01f, 9.38747924e-01f,
    9.39700859e-01f, 9.40639907e-01f, 9.41565240e-01f, 9.42477031e-01f,
    9.43375450e-01f, 9.44260667e-01f, 9.45132850e-01f, 9.45992166e-01f,
    9.46838781e-01f, 9.47672858e-01f, 9.48494561e-01f, 9.49304051e-01f,
    9.50101488e-01f, 9.50887030e-01f, 9.51660835e-01f, 9.52423058e-01f,
    9.53173854e-01f, 9.53913375e-01f, 9.54641772e-01f, 9.55359196e-01f,
    9.56065795e-01f, 9.56761715e-01f, 9.57447103e-01f, 9.58122102e-01f,
    9.58786854e-01f, 9.59441502e-01f, 9.60086183e-01f, 9.60721037e-01f,
    9.61346199e-01f, 9.61961805e-01f, 9.62567989e-01f, 9.63164883e-01f,
    9.63752617e-01f, 9.64331320e-01f, 9.64901121e-01f, 9.65462145e-01f,
    9.66014517e-01f, 9.66558362e-01f, 9.67093800e-01f, 9.67620952e-01f,
    9.68139937e-01f, 9.68650874e-01f, 9.69153878e-01f, 9.69649064e-01f,
    9.70136545e-01f, 9.70616434e-01f, 9.71088841e-01f, 9.71553876e-01f,
    9.72011646e-01f, 9.72462259e-01f, 9.72905818e-01f, 9.73342430e-01f,
    9.73772194e-01f, 9.74195215e-01f, 9.74611590e-01f, 9.75021419e-01f,
    9.75424799e-01f, 9.75821827e-01f, 9.76212596e-01f, 9.76597202e-01f,
    9.76975736e-01f, 9.77348289e-01f, 9.77714951e-01f, 9.78075812e-01f,
    9.78430957e-01f, 9.78780475e-01f, 9.79124450e-01f, 9.79462966e-01f,
    9.79796106e-01f, 9.80123951e-01f, 9.80446583e-01f, 9.80764080e-01f,
    9.81076522e-01f, 9.81383985e-01f, 9.81686546e-01f, 9.81984279e-01f,
    9.82277260e-01f, 9.82565560e-01f, 9.82849253e-01f, 9.83128409e-01f,
    9.83403097e-01f, 9.83673388e-01f, 9.83939349e-01f, 9.84201046e-01f,
    9.84458547e-01f, 9.84711916e-01f, 9.84961218e-01f, 9.85206516e-01f,
    9.85447871e-01f, 9.85685346e-01f, 9.85919001e-01f, 9.86148896e-01f,
    9.86375089e-01f, 9.86597639e-01f, 9.86816602e-01f, 9.87032034e-01f,
    9.87243992e-01f, 9.87452530e-01f, 9.87657701e-01f, 9.87859558e-01f,
    9.88058154e-01f, 9.88253539e-01f, 9.88445766e-01f, 9.88634883e-01f,
    9.88820939e-01f, 9.89003983e-01f, 9.89184063e-01f, 9.89361226e-01f,
    9.89535517e-01f, 9.89706983e-01f, 9.89875668e-01f, 9.90041617e-01f,
    9.90204872e-01f, 9.90365477e-01f, 9.90523473e-01f, 9.90678903e-01f,
    9.90831808e-01f, 9.90982227e-01f, 9.91130200e-01f, 9.91275766e-01f,
    9.91418965e-01f, 9.91559832e-01f, 9.91698407e-01f, 9.91834725e-01f,
    9.91968823e-01f, 9.92100736e-01f, 9.92230500e-01f, 9.92358148e-01f,
    9.92483715e-01f, 9.92607234e-01f, 9.92728738e-01f, 9.92848259e-01f,
    9.92965830e-01f, 9.93081481e-01f, 9.93195244e-01f, 9.93307149e-01f
};

// Linear interpolation for exp(-x) over [0, EXP_MAX_X]
float get_sigmoid_approx(float x) {
  if (x >= SIGMOID_MAX_X) return 1.0f;
  if (x <= SIGMOID_MIN_X) return 0.0f;

  float idx_f = (x - SIGMOID_MIN_X) / SIGMOID_STEP;
  int i = static_cast<int>(idx_f);
  float frac = idx_f - i;

  // Clamp to avoid out-of-bounds
  if (i >= SIGMOID_LUT_SIZE - 1) i = SIGMOID_LUT_SIZE - 2;

  float y0 = sigmoid_lut[i];
  float y1 = sigmoid_lut[i + 1];
  return y0 + frac * (y1 - y0);
}

extern "C" {

void silu_float32(float input_x[4][768], float output_x[4][768]) {
  constexpr int SEQ_TILE = 4;
  constexpr int FEATURE_DIM_TILE = 768;

  for (int iter = 0; iter < SEQ_TILE; iter++) {
    float *__restrict input_ptr = &input_x[iter][0];
    float *__restrict output_ptr = &output_x[iter][0];
    for (int i = 0; i < FEATURE_DIM_TILE; i++) {
      float x = input_ptr[i];
      float sigmoid = get_sigmoid_approx(x);
      // float sigmoid = 1.0f / (1.0f + exp_neg);
      output_ptr[i] = x * sigmoid;
    }
  }
}

} // extern "C"
